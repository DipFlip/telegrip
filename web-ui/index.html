<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>telegrip - Robot Arm Teleoperation</title>
    <meta name="description" content="telegrip - Robot Arm Teleoperation">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" type="image/x-icon" href="/favicon.ico">
    <script src="interface.js" defer></script>
    <link rel="stylesheet" href="styles.css">
  </head>
  <body>
    <!-- Settings Button -->
    <div class="settings-button" onclick="openSettings()">
      ‚öôÔ∏è
    </div>

    <!-- Settings Modal -->
    <div class="settings-modal" id="settingsModal">
      <div class="settings-content">
        <div class="settings-header">
          <div class="settings-title">System Configuration</div>
          <button class="close-button" onclick="closeSettings()">√ó</button>
        </div>
        
        <form id="settingsForm">
          <div class="settings-section">
            <h3>ü§ñ Robot Arms</h3>
            <div class="form-row">
              <div class="form-group">
                <label for="leftArmName">Left Arm Name</label>
                <input type="text" id="leftArmName" name="leftArmName">
              </div>
              <div class="form-group">
                <label for="leftArmPort">Left Arm Port</label>
                <input type="text" id="leftArmPort" name="leftArmPort" placeholder="/dev/ttyACM0">
              </div>
            </div>
            <div class="form-row">
              <div class="form-group">
                <label for="rightArmName">Right Arm Name</label>
                <input type="text" id="rightArmName" name="rightArmName">
              </div>
              <div class="form-group">
                <label for="rightArmPort">Right Arm Port</label>
                <input type="text" id="rightArmPort" name="rightArmPort" placeholder="/dev/ttyACM1">
              </div>
            </div>
          </div>

          <div class="settings-section">
            <h3>üåê Network Settings</h3>
            <div class="form-row">
              <div class="form-group">
                <label for="httpsPort">HTTPS Port</label>
                <input type="number" id="httpsPort" name="httpsPort" min="1024" max="65535">
              </div>
              <div class="form-group">
                <label for="websocketPort">WebSocket Port</label>
                <input type="number" id="websocketPort" name="websocketPort" min="1024" max="65535">
              </div>
            </div>
            <div class="form-group">
              <label for="hostIp">Host IP Address</label>
              <input type="text" id="hostIp" name="hostIp" placeholder="0.0.0.0">
            </div>
          </div>

          <div class="settings-section">
            <h3>üéÆ Control Parameters</h3>
            <div class="form-row">
              <div class="form-group">
                <label for="vrScale">VR Scale Factor</label>
                <input type="number" id="vrScale" name="vrScale" step="0.1" min="0.1" max="5.0">
              </div>
              <div class="form-group">
                <label for="sendInterval">Send Interval (ms)</label>
                <input type="number" id="sendInterval" name="sendInterval" step="1" min="10" max="200">
              </div>
            </div>
            <div class="form-row">
              <div class="form-group">
                <label for="posStep">Position Step (m)</label>
                <input type="number" id="posStep" name="posStep" step="0.001" min="0.001" max="0.1">
              </div>
              <div class="form-group">
                <label for="angleStep">Angle Step (degrees)</label>
                <input type="number" id="angleStep" name="angleStep" step="0.5" min="0.5" max="45">
              </div>
            </div>
          </div>

          <div class="button-row">
            <button type="submit" class="save-button" id="saveButton">
              üíæ Save Configuration
            </button>
            <button type="button" class="restart-button" id="restartButton" onclick="restartSystem()">
              üîÑ Restart System
            </button>
          </div>
        </form>
      </div>
    </div>

    <!-- Desktop Interface -->
    <div class="desktop-interface" id="desktopInterface">
      <div class="desktop-header">
        <div class="desktop-title">telegrip</div>
        <div class="desktop-subtitle">Dual-arm robot control via VR controllers and keyboard</div>
        
        <div class="status-section">
          <h2>ü§ñ Robot Status</h2>
          <div class="status-grid">
            <div class="status-item">
              <div class="status-indicator" id="leftArmStatus"></div>
              <span>Left Arm</span>
            </div>
            <div class="status-item">
              <div class="status-indicator" id="rightArmStatus"></div>
              <span>Right Arm</span>
            </div>
            <div class="status-item">
              <div class="status-indicator" id="vrStatus"></div>
              <span>VR Connected</span>
            </div>
          </div>
          
          <!-- Robot Engagement Controls -->
          <div class="robot-controls">
            <button id="robotEngageBtn" class="engage-btn" onclick="toggleRobotEngagement()">
              <span id="engageBtnText">üîå Connect Robot</span>
            </button>
            <div class="engagement-status">
              <span id="engagementStatusText">Motors Disengaged</span>
            </div>
          </div>
        </div>

        <!-- VR Access Section -->
        <div class="vr-access-section">
          <h2>ü•Ω VR Teleoperation</h2>
          <div class="vr-access-content">
            <div class="vr-access-info">
              <div class="vr-instructions-image">
                <img src="media/telegrip_instructions.jpg" alt="VR Controller Instructions" style="max-width: 100%; height: auto; border-radius: 8px; box-shadow: 0 4px 8px rgba(0,0,0,0.1);">
              </div>
              <div class="vr-features">
                <div class="vr-feature">
                  <span><strong>Grip Button:</strong> Hold to move robot arm with your controller</span>
                </div>
                <div class="vr-feature">
                  <span><strong>Trigger Button:</strong> Hold to close gripper, release to open</span>
                </div>
                <div class="vr-feature">
                  <span><strong>Controller Orientation:</strong> Robot wrist follows your controller rotation</span>
                </div>
              </div>
            </div>
            <div class="vr-access-controls">
              <button class="vr-enter-btn" id="vrEnterBtn" onclick="enterVR()">
                <span class="vr-enter-icon">ü•Ω</span>
                <span class="vr-enter-text">Enter VR</span>
                <span class="vr-enter-subtitle">Click from within the VR headset</span>
              </button>
              <div class="vr-status-text" id="vrStatusText">
                <span id="vrTunnelStatus">‚è≥ Preparing VR environment...</span>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="keyboard-help">
        <!-- Collapsed state: just the enable button -->
        <div class="keyboard-help-collapsed">
          <div class="control-toggle" id="keyboardToggle" onclick="toggleKeyboardControl()">
            <span>üéÆ</span>
            <span id="keyboardToggleText">Enable Keyboard Control</span>
          </div>
        </div>
        
        <!-- Expanded state: title, disable button, and content -->
        <div class="keyboard-help-expanded">
          <div class="keyboard-help-header">
            <div class="control-toggle active" onclick="toggleKeyboardControl()">
              <span>üéÆ</span>
              <span>Disable Keyboard Control</span>
            </div>
            <div class="help-title">
              <span>‚å®Ô∏è</span>
              Keyboard Controls
            </div>
          </div>
          
          <div class="help-columns">
            <div class="help-column">
              <h4>Left Arm</h4>
              <div class="key-group">
                <div class="key-row">
                  <span><kbd class="key">W</kbd> / <kbd class="key">S</kbd></span>
                  <span class="key-desc">Forward / Backward</span>
                </div>
                <div class="key-row">
                  <span><kbd class="key">A</kbd> / <kbd class="key">D</kbd></span>
                  <span class="key-desc">Left / Right</span>
                </div>
                <div class="key-row">
                  <span><kbd class="key">Q</kbd> / <kbd class="key">E</kbd></span>
                  <span class="key-desc">Down / Up</span>
                </div>
                <div class="key-row">
                  <span><kbd class="key">Z</kbd> / <kbd class="key">X</kbd></span>
                  <span class="key-desc">Wrist Roll</span>
                </div>
                <div class="key-row">
                  <span><kbd class="key">F</kbd></span>
                  <span class="key-desc">Toggle Gripper</span>
                </div>
              </div>
            </div>
            
            <div class="help-column">
              <h4>Right Arm</h4>
              <div class="key-group">
                <div class="key-row">
                  <span><kbd class="key">I</kbd> / <kbd class="key">K</kbd></span>
                  <span class="key-desc">Forward / Backward</span>
                </div>
                <div class="key-row">
                  <span><kbd class="key">J</kbd> / <kbd class="key">L</kbd></span>
                  <span class="key-desc">Left / Right</span>
                </div>
                <div class="key-row">
                  <span><kbd class="key">U</kbd> / <kbd class="key">O</kbd></span>
                  <span class="key-desc">Up / Down</span>
                </div>
                <div class="key-row">
                  <span><kbd class="key">N</kbd> / <kbd class="key">M</kbd></span>
                  <span class="key-desc">Wrist Roll</span>
                </div>
                <div class="key-row">
                  <span><kbd class="key">;</kbd></span>
                  <span class="key-desc">Toggle Gripper</span>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script>
      // Enter VR function
      async function enterVR() {
        const button = document.getElementById('vrEnterBtn');
        const statusText = document.getElementById('vrTunnelStatus');
        
        try {
          button.disabled = true;
          button.querySelector('.vr-enter-text').textContent = 'Opening...';
          statusText.textContent = 'üöÄ Opening VR interface...';
          
          // Get tunnel URL from API
          const response = await fetch('/api/tunnel-url');
          const data = await response.json();
          
          if (data.tunnel_url) {
            // Open VR page in tunnel
            const vrUrl = data.tunnel_url + '/vr.html';
            window.open(vrUrl, '_blank');
            statusText.textContent = '‚úÖ VR interface opened in new tab';
          } else {
            // Fallback to local VR page (for offline mode)
            const vrUrl = window.location.origin + '/vr.html';
            window.open(vrUrl, '_blank');
            statusText.textContent = '‚úÖ VR interface opened locally';
          }
          
        } catch (error) {
          console.error('Error opening VR:', error);
          statusText.textContent = '‚ùå Error opening VR interface';
        } finally {
          // Reset button after delay
          setTimeout(() => {
            button.disabled = false;
            button.querySelector('.vr-enter-text').textContent = 'Enter VR';
          }, 2000);
        }
      }
      
      // Update VR tunnel status
      async function updateVRTunnelStatus() {
        try {
          const response = await fetch('/api/tunnel-url');
          const data = await response.json();
          const statusText = document.getElementById('vrTunnelStatus');
          
          if (data.tunnel_url) {
            statusText.textContent = 'üåê VR ready via secure tunnel';
          } else {
            statusText.textContent = 'üîí VR ready via local HTTPS (may show certificate warning)';
          }
        } catch (error) {
          console.error('Error checking tunnel status:', error);
        }
      }
      
      // Initialize on page load
      document.addEventListener('DOMContentLoaded', function() {
        updateVRTunnelStatus();
        // Check tunnel status periodically
        setInterval(updateVRTunnelStatus, 5000);
      });
    </script>
  </body>
</html> 